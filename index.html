<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Firebase Realtime DB Live Stream</title>
  <style>
    #liveStreamView {
      width: 320px;
      height: 240px;
      border: 1px solid black;
      background: #000;
    }
  </style>
</head>
<body>
  <h1>Firebase Realtime DB Live Stream Demo</h1>

  <button id="startStreamBtn">Start Streaming (Sender)</button>
  <button id="startReceiveBtn">Start Receiving (Viewer)</button>
  
  <br /><br />
  <img id="liveStreamView" alt="Live Stream Here" />

  <script type="module">
    // Import Firebase SDK modules from CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.3.0/firebase-database.js";

    // Your Firebase config - CHANGE TO YOUR OWN CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74",
      measurementId: "G-WXBEP1LXTX"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Reference for live stream frame in Realtime Database
    const streamRef = ref(db, 'liveStream/frame');

    // Streaming sender
    async function startStreaming() {
      const video = document.createElement('video');
      video.autoplay = true;

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;
      } catch (err) {
        alert("Error accessing camera: " + err.message);
        return;
      }

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      video.addEventListener('loadedmetadata', () => {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        setInterval(() => {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const frameData = canvas.toDataURL('image/jpeg', 0.5); // compress quality

          // Push frame to Firebase Realtime Database
          set(streamRef, frameData);
        }, 100); // ~10 fps
      });
    }

    // Streaming receiver
    function startReceiving() {
      const img = document.getElementById('liveStreamView');

      onValue(streamRef, (snapshot) => {
        const frameData = snapshot.val();
        if (frameData) {
          img.src = frameData;
        }
      });
    }

    // Button event listeners
    document.getElementById('startStreamBtn').onclick = startStreaming;
    document.getElementById('startReceiveBtn').onclick = startReceiving;
  </script>
</body>
</html>
