<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Messenger App</title>
<style>
  /* your existing CSS unchanged */
  body, html {
    margin: 0; padding: 0; height: 100%;
    font-family: Arial, sans-serif;
    background: #f2f2f2;
  }
  #root {
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .login-container {
    background: white;
    padding: 30px 40px;
    border-radius: 10px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    width: 320px;
    text-align: center;
  }
  .login-container h2 {
    margin-bottom: 20px;
  }
  .login-input {
    width: 100%;
    padding: 10px 12px;
    margin-bottom: 15px;
    border: 1.5px solid #ccc;
    border-radius: 6px;
    font-size: 16px;
    transition: border-color 0.3s ease;
  }
  .login-input:focus {
    border-color: #007bff;
    outline: none;
  }
  .login-btn {
    width: 100%;
    padding: 10px 0;
    background: #007bff;
    border: none;
    border-radius: 6px;
    color: white;
    font-size: 17px;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .login-btn:hover {
    background: #0056b3;
  }
  .error-msg {
    color: #d33;
    margin-top: 10px;
  }
  /* Chat styles */
  .chat-container {
    height: 90vh;
    width: 400px;
    max-width: 95vw;
    background: white;
    display: flex;
    flex-direction: column;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.12);
    overflow: hidden;
  }
  .chat-header {
    background: #007bff;
    color: white;
    padding: 15px 20px;
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .logout-btn {
    background: transparent;
    border: 1.5px solid white;
    border-radius: 6px;
    color: white;
    padding: 6px 14px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s ease;
  }
  .logout-btn:hover {
    background: rgba(255,255,255,0.2);
  }
  .messages-container {
    flex: 1;
    padding: 15px 20px;
    overflow-y: auto;
    background: #e9ecef;
  }
  .message-row {
    display: flex;
    margin-bottom: 12px;
  }
  .message-row.you {
    justify-content: flex-end;
  }
  .message-bubble {
    max-width: 70%;
    padding: 10px 14px;
    border-radius: 15px;
    position: relative;
    font-size: 15px;
    line-height: 1.3;
    word-break: break-word;
  }
  .message-bubble.you {
    background: #007bff;
    color: white;
    border-bottom-right-radius: 2px;
  }
  .message-bubble.other {
    background: white;
    color: #222;
    border-bottom-left-radius: 2px;
  }
  .sender-name {
    font-size: 12px;
    font-weight: 600;
    margin-bottom: 4px;
    opacity: 0.7;
  }
  .timestamp {
    font-size: 10px;
    opacity: 0.5;
    margin-top: 6px;
    text-align: right;
  }
  img {
    max-width: 100%;
    border-radius: 10px;
    cursor: pointer;
  }
  video {
    max-width: 100%;
    border-radius: 10px;
    cursor: pointer;
  }
  audio {
    width: 100%;
    margin-top: 5px;
  }
  .file-link {
    color: #007bff;
    text-decoration: underline;
    cursor: pointer;
  }
  .input-area {
    display: flex;
    padding: 10px 15px;
    border-top: 1.5px solid #ddd;
    background: white;
  }
  .input-area input[type="text"] {
    flex-grow: 1;
    padding: 10px 14px;
    font-size: 15px;
    border: 1.5px solid #ccc;
    border-radius: 25px;
    outline: none;
    transition: border-color 0.3s ease;
  }
  .input-area input[type="text"]:focus {
    border-color: #007bff;
  }
  .file-label {
    font-size: 22px;
    cursor: pointer;
    padding: 0 12px;
    user-select: none;
    line-height: 1;
  }
  #file-upload {
    display: none;
  }
  .send-btn {
    background: #007bff;
    border: none;
    color: white;
    font-weight: 600;
    border-radius: 25px;
    padding: 0 20px;
    margin-left: 10px;
    cursor: pointer;
    font-size: 15px;
    transition: background 0.3s ease;
    user-select: none;
  }
  .send-btn:disabled {
    background: #8ab9ff;
    cursor: default;
  }
  .send-btn.sending {
    cursor: wait;
  }
  a {
    color: #007bff;
    word-break: break-word;
  }
</style>
</head>
<body>
<div id="root"></div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

<script>
const e = React.createElement;

// Firebase config and init
const firebaseConfig = {
  apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
  authDomain: "project-955237504610034331.firebaseapp.com",
  projectId: "project-955237504610034331",
  storageBucket: "project-955237504610034331.firebasestorage.app",
  messagingSenderId: "76212939677",
  appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74",
  measurementId: "G-WXBEP1LXTX"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

function Login({ onLogin }) {
  const [email, setEmail] = React.useState("");
  const [password, setPassword] = React.useState("");
  const [error, setError] = React.useState("");

  const handleLogin = () => {
    if (!email || !password) {
      setError("Please enter email and password.");
      return;
    }
    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        onLogin(userCredential.user);
        setError("");
      })
      .catch(err => {
        setError(err.message);
      });
  };

  return e("div", { className: "login-container" },
    e("h2", null, "Messenger Login"),
    e("input", {
      className: "login-input",
      type: "email",
      placeholder: "Email",
      value: email,
      onChange: e => setEmail(e.target.value),
      onKeyDown: e => { if (e.key === "Enter") handleLogin(); }
    }),
    e("input", {
      className: "login-input",
      type: "password",
      placeholder: "Password",
      value: password,
      onChange: e => setPassword(e.target.value),
      onKeyDown: e => { if (e.key === "Enter") handleLogin(); }
    }),
    e("button", { className: "login-btn", onClick: handleLogin }, "Login"),
    error && e("div", { className: "error-msg" }, error)
  );
}

function formatTimestamp(ts) {
  if (!ts) return "";
  const date = ts.toDate ? ts.toDate() : ts;
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
}

function Message({ message, currentUser }) {
  const isYou = message.sender === currentUser;
  const bubbleClass = isYou ? "message-bubble you" : "message-bubble other";
  const { type, content } = message;

  function linkify(text) {
    const urlRegex = /(\bhttps?:\/\/[^\s]+)/gi;
    return text.split(urlRegex).map((part, i) => {
      if (part.match(urlRegex)) {
        return e("a", { key: i, href: part, target: "_blank", rel: "noopener noreferrer" }, part);
      }
      return part;
    });
  }

  const openInNewTab = (url) => {
    window.open(url, "_blank", "noopener,noreferrer");
  };

  return e("div", { className: `message-row ${isYou ? "you" : "other"}` },
    e("div", { className: bubbleClass },
      e("div", { className: "sender-name" }, message.sender),
      type === "text" && e("div", null, linkify(content)),
      type === "image" && e("img", {
        src: content,
        alt: "sent image",
        onClick: () => openInNewTab(content),
        loading: "lazy"
      }),
      type === "video" && e("video", {
        src: content,
        controls: true,
        onClick: e => e.stopPropagation()
      }),
      type === "audio" && e("audio", { controls: true, src: content }),
      type === "file" && e("a", {
        href: content,
        className: "file-link",
        target: "_blank",
        rel: "noopener noreferrer"
      }, "Open file"),
      e("div", { className: "timestamp" }, formatTimestamp(message.createdAt))
    )
  );
}

function ChatApp({ user, onLogout }) {
  const [messages, setMessages] = React.useState([]);
  const [text, setText] = React.useState("");
  const [sending, setSending] = React.useState(false);
  const fileInputRef = React.useRef(null);
  const messagesEndRef = React.useRef(null);

  React.useEffect(() => {
    const unsubscribe = db.collection("messages")
      .orderBy("createdAt", "asc")
      .onSnapshot((snapshot) => {
        const msgs = [];
        snapshot.forEach(doc => {
          msgs.push({ id: doc.id, ...doc.data() });
        });
        setMessages(msgs);
        messagesEndRef.current?.scrollIntoView({ behavior: "auto" });
      });
    return () => unsubscribe();
  }, []);

  const handleSendText = async () => {
    const trimmed = text.trim();
    if (!trimmed) return;

    const localMsg = {
      id: Date.now() + "_local",
      sender: user.email,
      content: trimmed,
      type: "text",
      createdAt: new Date()
    };
    setMessages(prev => [...prev, localMsg]);
    setText("");

    try {
      await db.collection("messages").add({
        sender: user.email,
        content: trimmed,
        type: "text",
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      setMessages(prev => prev.filter(m => m.id !== localMsg.id));
    } catch (err) {
      alert("Error sending message: " + err.message);
      setMessages(prev => prev.filter(m => m.id !== localMsg.id));
    }
  };

  const handleKeyDown = (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      if (!sending) handleSendText();
    }
  };

  const handleFileChange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.size > 10 * 1024 * 1024) {
      alert("File size exceeds 10MB limit.");
      e.target.value = null;
      return;
    }

    let fileType = "file";
    if (file.type.startsWith("image/")) fileType = "image";
    else if (file.type.startsWith("video/")) fileType = "video";
    else if (file.type.startsWith("audio/")) fileType = "audio";

    const localMsg = {
      id: Date.now() + "_local",
      sender: user.email,
      content: URL.createObjectURL(file),
      type: fileType,
      createdAt: new Date()
    };

    setMessages(prev => [...prev, localMsg]);
    e.target.value = null;

    try {
      const fileRef = storage.ref(`uploads/${Date.now()}_${file.name}`);
      await fileRef.put(file);
      const url = await fileRef.getDownloadURL();

      await db.collection("messages").add({
        sender: user.email,
        content: url,
        type: fileType,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      });

      setMessages(prev => prev.filter(m => m.id !== localMsg.id));
    } catch (err) {
      alert("Failed to upload file: " + err.message);
      setMessages(prev => prev.filter(m => m.id !== localMsg.id));
    }
  };

  return e("div", { className: "chat-container" },
    e("header", { className: "chat-header" },
      `Logged in as: ${user.email}`,
      e("button", { className: "logout-btn", onClick: () => { auth.signOut(); onLogout(); } }, "Logout")
    ),
    e("main", { className: "messages-container" },
      messages.map(m =>
        e(Message, { key: m.id, message: m, currentUser: user.email })
      ),
      e("div", { ref: messagesEndRef })
    ),
    e("div", { className: "input-area" },
      e("input", {
        type: "text",
        placeholder: "Type a message...",
        value: text,
        onChange: e => setText(e.target.value),
        onKeyDown: handleKeyDown,
        disabled: sending
      }),
      e("label", { htmlFor: "file-upload", className: "file-label", title: "Send file" }, "📎"),
      e("input", {
        id: "file-upload",
        type: "file",
        onChange: handleFileChange,
        ref: fileInputRef,
        disabled: sending
      }),
      e("button", {
        className: "send-btn",
        onClick: handleSendText,
        disabled: sending || !text.trim()
      }, "Send")
    )
  );
}

function App() {
  const [user, setUser] = React.useState(null);

  React.useEffect(() => {
    const unsubscribe = auth.onAuthStateChanged(currentUser => {
      if (currentUser) setUser(currentUser);
      else setUser(null);
    });
    return () => unsubscribe();
  }, []);

  if (!user) return e(Login, { onLogin: setUser });

  return e(ChatApp, { user, onLogout: () => setUser(null) });
}

ReactDOM.createRoot(document.getElementById("root")).render(e(App));
</script>
</body>
</html>
