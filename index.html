<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Skyblue Realtime Messenger</title>
  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      background: #ece5dd;
    }
    #app {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 16px;
    }
    .container {
      background: #fff;
      width: 100%;
      max-width: 440px;
      height: 100%;
      display: flex;
      flex-direction: column;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.12);
      overflow: hidden;
    }
    .header {
      background: #4ca3dd; /* skyblue instead of dark green */
      color: white;
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 16px;
      user-select: none;
    }
    .header .btn-group {
      display: flex;
      gap: 8px;
    }
    button.logout, button.settings {
      border: 1.5px solid white;
      background: transparent;
      padding: 6px 12px;
      border-radius: 6px;
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background-color 0.25s;
    }
    button.logout:hover, button.settings:hover {
      background: rgba(255 255 255 / 0.2);
    }
    .messages {
      flex: 1;
      padding: 16px 12px;
      overflow-y: auto;
      background: #e5ddd5;
      display: flex;
      flex-direction: column;
      gap: 10px;
      scrollbar-width: thin;
      scrollbar-color: #aaa transparent;
    }
    .messages::-webkit-scrollbar {
      width: 8px;
    }
    .messages::-webkit-scrollbar-thumb {
      background-color: #aaa;
      border-radius: 4px;
    }
    .message {
      max-width: 75%;
      padding: 12px 14px;
      border-radius: 12px;
      background: #a9d5ff; /* lighter skyblue bubble */
      align-self: flex-end;
      position: relative;
      word-wrap: break-word;
      font-size: 14px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      user-select: text;
      line-height: 1.3;
      color: #003366;
    }
    .message.other {
      background: white;
      align-self: flex-start;
      color: #202c33;
    }
    .message strong {
      display: block;
      margin-bottom: 6px;
      font-weight: 700;
      font-size: 13px;
      color: #202c33;
    }
    .message img,
    .message video,
    .message audio {
      max-width: 100%;
      border-radius: 10px;
      margin-top: 4px;
      outline: none;
    }
    .timestamp {
      font-size: 10px;
      color: #555;
      margin-top: 6px;
      text-align: right;
      user-select: none;
    }
    .delete-btn {
      position: absolute;
      top: 6px;
      right: 8px;
      color: #d93025;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 14px;
      font-weight: 700;
      line-height: 1;
      user-select: none;
    }
    .input-area {
      display: flex;
      border-top: 1px solid #ccc;
      padding: 12px 14px;
      background: #fff;
      gap: 8px;
    }
    .input-area input[type="text"] {
      flex: 1;
      padding: 12px 16px;
      border-radius: 25px;
      border: 1px solid #ccc;
      outline: none;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    .input-area input[type="text"]:focus {
      border-color: #4ca3dd; /* skyblue */
    }
    .input-area button.send {
      background: #4ca3dd; /* skyblue */
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 25px;
      cursor: pointer;
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      transition: background-color 0.3s;
    }
    .input-area button.send:hover {
      background: #357abd; /* darker skyblue */
    }
    .input-area button.attach {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 20px;
      user-select: none;
      color: #4ca3dd;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .input-area input[type="file"] {
      display: none;
    }

    /* Login */
    .login-box {
      background: white;
      padding: 32px 32px 40px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.12);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    .login-box h2 {
      margin-bottom: 24px;
      font-weight: 700;
      color: #4ca3dd;
      user-select: none;
    }
    .login-box input {
      display: block;
      width: 100%;
      margin-bottom: 18px;
      padding: 14px 16px;
      font-size: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      transition: border-color 0.3s;
    }
    .login-box input:focus {
      border-color: #4ca3dd;
    }
    .login-box button {
      width: 100%;
      padding: 14px 0;
      background: #4ca3dd;
      border: none;
      color: white;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
    }
    .login-box button:hover {
      background: #357abd;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
    const appDiv = document.getElementById('app');

    const firebaseConfig = {
      apiKey: "AIzaSyCy9CKJ6CELheBhw7Gs0BgsE1E0FsoYdgU",
      authDomain: "project-955237504610034331.firebaseapp.com",
      databaseURL: "https://project-955237504610034331-default-rtdb.firebaseio.com",
      projectId: "project-955237504610034331",
      storageBucket: "project-955237504610034331.appspot.com",
      messagingSenderId: "76212939677",
      appId: "1:76212939677:web:ef498bc1e4e480ab6e5d74"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();
    const storage = firebase.storage();

    let currentDisplayName = "";
    let currentUser = null;

    function renderLogin() {
      appDiv.innerHTML = `
        <div class="login-box">
          <h2>Messenger Login</h2>
          <input type="email" id="email" placeholder="Email" autocomplete="username" />
          <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
          <button onclick="login()">Login</button>
        </div>
      `;
    }

    function renderChat(user) {
      currentUser = user;
      appDiv.innerHTML = `
        <div class="container">
          <div class="header">
            <div id="displayName">${currentDisplayName || user.email}</div>
            <div class="btn-group">
              <button class="settings" onclick="promptChangeName()">Name</button>
              <button class="logout" onclick="logout()">Logout</button>
            </div>
          </div>
          <div class="messages" id="messages"></div>
          <div class="input-area">
            <input type="text" id="msgInput" placeholder="Type a message" autocomplete="off" />
            <button class="attach" title="Attach media" onclick="document.getElementById('mediaInput').click()">ðŸ“Ž</button>
            <input type="file" id="mediaInput" accept="image/*,video/*,audio/*" onchange="sendMedia()" />
            <button class="send" title="Send message" onclick="sendMessage()">âž¤</button>
          </div>
        </div>
      `;
      loadMessages(user);
      scrollToBottom();
    }

    async function loadDisplayName() {
      if (!currentUser) return;
      const nameRef = db.ref(`displayNames/${currentUser.uid}`);
      const snapshot = await nameRef.once('value');
      const name = snapshot.val();
      if (name) {
        currentDisplayName = name;
      } else {
        currentDisplayName = currentUser.email;
      }
    }

    function promptChangeName() {
      const newName = prompt("Enter your display name:", currentDisplayName || "");
      if (newName && newName.trim().length >= 2) {
        currentDisplayName = newName.trim();
        document.getElementById('displayName').textContent = currentDisplayName;
        db.ref(`displayNames/${currentUser.uid}`).set(currentDisplayName);
      } else if (newName !== null) {
        alert("Display name must be at least 2 characters.");
      }
    }

    function displayMessage(id, msg) {
      const messagesDiv = document.getElementById("messages");
      if (!messagesDiv) return;

      // Skip if message already exists (avoid duplicates)
      if (document.getElementById('msg-' + id)) return;

      let div = document.createElement("div");
      div.classList.add("message");
      div.id = 'msg-' + id;
      if (msg.sender !== currentUser.uid) div.classList.add("other");

      if (msg.sender !== currentUser.uid) {
        getDisplayName(msg.sender).then(senderName => {
          const strong = document.createElement('strong');
          strong.textContent = senderName || "Unknown";
          div.insertBefore(strong, div.firstChild);
        });
      }

      if (msg.text) {
        const textNode = document.createTextNode(msg.text);
        div.appendChild(textNode);
      }

      if (msg.mediaURL) {
        let mediaElem = null;
        if (msg.mediaType.startsWith('image/')) {
          mediaElem = document.createElement('img');
          mediaElem.src = msg.mediaURL;
          mediaElem.alt = "image";
          mediaElem.loading = "lazy";
        } else if (msg.mediaType.startsWith('video/')) {
          mediaElem = document.createElement('video');
          mediaElem.src = msg.mediaURL;
          mediaElem.controls = true;
          mediaElem.preload = "metadata";
        } else if (msg.mediaType.startsWith('audio/')) {
          mediaElem = document.createElement('audio');
          mediaElem.src = msg.mediaURL;
          mediaElem.controls = true;
          mediaElem.preload = "metadata";
        }
        if (mediaElem) {
          div.appendChild(document.createElement('br'));
          div.appendChild(mediaElem);
        }
      }

      const tsDiv = document.createElement('div');
      tsDiv.className = "timestamp";
      const date = new Date(msg.timestamp || Date.now());
      tsDiv.textContent = date.toLocaleString();
      div.appendChild(tsDiv);

      if (msg.sender === currentUser.uid) {
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.title = "Delete message";
        deleteBtn.textContent = "Ã—";
        deleteBtn.onclick = () => {
          if (confirm("Delete this message?")) {
            deleteMessage(id, msg);
          }
        };
        div.appendChild(deleteBtn);
      }

      messagesDiv.appendChild(div);
      scrollToBottom();
    }

    async function getDisplayName(uid) {
      const snapshot = await db.ref(`displayNames/${uid}`).once('value');
      return snapshot.val() || "Anonymous";
    }

    function scrollToBottom() {
      const messagesDiv = document.getElementById("messages");
      if (messagesDiv) {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    }

    function loadMessages(user) {
      const messagesDiv = document.getElementById("messages");
      messagesDiv.innerHTML = "";

      const messagesRef = db.ref('messages').limitToLast(100);
      messagesRef.off();

      messagesRef.on('child_added', snapshot => {
        const msg = snapshot.val();
        displayMessage(snapshot.key, msg);
      });
      messagesRef.on('child_removed', snapshot => {
        const msgId = snapshot.key;
        const el = document.getElementById('msg-' + msgId);
        if (el) el.remove();
      });
    }

    function sendMessage() {
      const input = document.getElementById("msgInput");
      if (!input.value.trim()) return;
      const text = input.value.trim();
      const msgData = {
        text,
        sender: currentUser.uid,
        timestamp: Date.now()
      };
      db.ref('messages').push(msgData);
      input.value = "";
    }

    // Limit media size to 1GB
    const MAX_MEDIA_SIZE = 1024 * 1024 * 1024; // 1GB in bytes

    async function sendMedia() {
      const fileInput = document.getElementById("mediaInput");
      if (fileInput.files.length === 0) return;

      const file = fileInput.files[0];
      fileInput.value = ""; // reset input

      if (file.size > MAX_MEDIA_SIZE) {
        alert("File size exceeds 1GB limit.");
        return;
      }

      const msgId = db.ref('messages').push().key;
      const storageRef = storage.ref(`chat_media/${currentUser.uid}/${msgId}_${file.name}`);

      try {
        const uploadTaskSnapshot = await storageRef.put(file);
        const downloadURL = await uploadTaskSnapshot.ref.getDownloadURL();

        const msgData = {
          sender: currentUser.uid,
          mediaURL: downloadURL,
          mediaType: file.type,
          timestamp: Date.now()
        };
        await db.ref(`messages/${msgId}`).set(msgData);
      } catch (error) {
        alert("Upload failed: " + error.message);
      }
    }

    async function deleteMessage(id, msg) {
      if (msg.mediaURL) {
        try {
          const storageRef = storage.refFromURL(msg.mediaURL);
          await storageRef.delete();
        } catch (err) {
          console.warn("Failed to delete media from storage:", err.message);
        }
      }
      await db.ref(`messages/${id}`).remove();
    }

    async function login() {
      const emailInput = document.getElementById("email");
      const passInput = document.getElementById("password");
      const email = emailInput.value.trim();
      const password = passInput.value;
      if (!email || !password) {
        alert("Please enter email and password.");
        return;
      }
      try {
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = userCredential.user;
        await loadDisplayName();
        renderChat(currentUser);
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    }

    function logout() {
      auth.signOut();
    }

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        currentUser = user;
        await loadDisplayName();
        renderChat(user);
      } else {
        currentUser = null;
        renderLogin();
      }
    });

    // Expose functions globally for inline handlers
    window.login = login;
    window.logout = logout;
    window.sendMessage = sendMessage;
    window.sendMedia = sendMedia;
    window.promptChangeName = promptChangeName;
  </script>
</body>
</html>
